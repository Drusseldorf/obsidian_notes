# 11.44 JOIN LATERAL

`LATERAL JOIN` — может применяться вместе с любой операцией JOIN, например, с INNER JOIN, LEFT JOIN, RIGHT JOIN и т.д., и позволяет правому операнду получить доступ к столбцам левого операнда. Он полезен в ситуациях, когда вам нужно динамически связывать данные между строками двух таблиц или когда подзапрос зависит от данных, уже выбранных из левого операнда (например, предыдущей таблицы в `JOIN`).

### Как работает LATERAL

- `LATERAL` предоставляет доступ к колонкам левого операнда (таблицы или подзапроса) в подзапросе, который выполняется для каждой строки. То есть, для каждой строки левой таблицы выполняется подзапрос, который может использовать её значения.

### Пример:

```sql
SELECT
    a.name as author,
    b.name as last_added_book
FROM
    author a
JOIN LATERAL (
    SELECT name
    FROM book
    WHERE book.author_id = a.author_id
    ORDER BY created_at DESC NULLS LAST
    LIMIT 1
) b ON true
ORDER BY author;
```

### Где полезно использовать `LATERAL JOIN`:

1. **Выборка последних записей**. Например, нужно достать последнюю книгу каждого автора. Вместо сложных подзапросов можно использовать `LATERAL`, что значительно упрощает запрос.
2. **Работа с несколькими результатами подзапроса**. Если стандартный подзапрос может вернуть только одну строку и одно значение, то с `LATERAL JOIN` можно вернуть сразу несколько строк (например, `LIMIT 2`) для каждой строки из левой таблицы.
3. **Взаимодействие данных между таблицами**. Когда вам нужно провести вычисления или фильтрацию для каждой строки на основе динамических данных из другой таблицы.

### Более сложные примеры:

1. **Возвращаем несколько последних книг для каждого автора:**

```sql
SELECT
    a.name as author,
    b.name as book_name
FROM
    author a
JOIN LATERAL (
    SELECT name
    FROM book
    WHERE book.author_id = a.author_id
    ORDER BY created_at DESC
    LIMIT 2
) b ON true;
```

### Важные моменты:

- **Динамический доступ**. `LATERAL` позволяет динамически использовать данные из левой таблицы в правой таблице.
- **Совместимость с любым JOIN**. Вы можете применять `LATERAL` вместе с любым типом `JOIN`, включая `INNER JOIN`, `LEFT JOIN`, `RIGHT JOIN`.
- **Поддержка нескольких строк**. В отличие от стандартных подзапросов, `LATERAL` поддерживает выборку нескольких строк для каждой строки из левой таблицы.

`LATERAL JOIN` стоит использовать в тех случаях, когда стандартные подзапросы ограничены возможностями и не дают гибкости в работе с несколькими строками или сложной логикой.