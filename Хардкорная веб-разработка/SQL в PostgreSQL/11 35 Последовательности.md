# 11.35 Последовательности

Последовательности (`sequence`) в PostgreSQL — это специальные объекты, которые используются для генерации уникальных числовых значений, чаще всего для автозаполнения значений первичных ключей в таблицах. Когда вы создаёте колонку с типом `GENERATED ALWAYS AS IDENTITY`, PostgreSQL автоматически создаёт последовательность для этой колонки.

### Пример информации о таблице с использованием последовательности

Используя команду `\d author` в psql, можно увидеть информацию о таблице `author`, включая то, что для колонки `author_id` используется последовательность:

```sql
rroom_db=> \d author
                                   Table "public.author"
   Column    |          Type          | Collation | Nullable |           Default
-------------+------------------------+-----------+----------+------------------------------
 author_id   | bigint                 |           | not null | generated always as identity
 name        | character varying(150) |           | not null |
 description | text                   |           |          |
Indexes:
    "author_pkey" PRIMARY KEY, btree (author_id)
```

### Информация о последовательностях в базе данных

Чтобы увидеть список всех последовательностей в базе данных, можно использовать команду `\d`:

```sql
rroom_db=> \d
                         List of relations
 Schema |             Name              |   Type   | Owner
--------+-------------------------------+----------+-------
 public | author                        | table    | rroom
 public | author_author_id_seq          | sequence | rroom
 public | book                          | table    | rroom
 public | book_book_id_seq              | sequence | rroom
 public | book_category                 | table    | rroom
 public | book_category_category_id_seq | sequence | rroom
(6 rows)
```

### Пример работы с последовательностью

Для понимания работы с последовательностями создадим свою последовательность и проведем несколько операций:

1. **Создание последовательности**:
    
    ```sql
    CREATE SEQUENCE tmp_seq
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    INCREMENT BY 1
    CACHE 1
    NO CYCLE;
    ```
    
    - `START 1` — последовательность начнётся с 1.
    - `INCREMENT BY 1` — последовательность увеличивается на 1 при каждом вызове.
    - `NO CYCLE` — последовательность не будет повторяться после достижения максимального значения.
2. **Получение следующего значения из последовательности**:
    
    Каждый раз при вызове `nextval` последовательность увеличивается и возвращает следующее значение:
    
    ```sql
    SELECT nextval('tmp_seq'); -- 1
    SELECT nextval('tmp_seq'); -- 2
    SELECT nextval('tmp_seq'); -- 3
    ```
    
3. **Получение текущего значения последовательности**:
    
    Функция `currval` возвращает текущее значение последовательности (последнее сгенерированное значение):
    
    ```sql
    SELECT currval('tmp_seq'); -- 3
    ```
    
4. **Удаление последовательности**:
    
    После работы можно удалить последовательность:
    
    ```sql
    DROP SEQUENCE tmp_seq;
    ```
    

Последовательности часто используются автоматически для колонок с типом `SERIAL` или `GENERATED ALWAYS AS IDENTITY`, но можно работать с ними и напрямую, как показано в примере.

## Пример использования последовательности для нумерации заказов

Интересный пример использования последовательностей — нумерация заказов в интернет-магазине, где номер заказа состоит из текущей даты и порядкового номера заказа за этот день.

Формат номера заказа:

- Первая часть — текущая дата в формате `YYYYMMDD` (год, месяц, день).
- Вторая часть — трехзначный порядковый номер заказа в этот день, начиная с `001`.

### Задача

Каждый день нумерация заказов сбрасывается. Например, первый заказ 31 июля 2024 года будет иметь номер `20240731001`, а первый заказ 1 августа 2024 года — `20240801001`. Предполагается, что более 999 заказов в день не бывает.

### Решение

1. Создаем последовательность `orders_seq`, которая будет управлять порядковым номером заказов.
    
    ```sql
    CREATE SEQUENCE orders_seq;
    ```
    
2. Для того чтобы сбросить последовательность каждый день, установим её значение в формате `YYYYMMDD000`, где `000` — начальный номер заказа за текущий день.
    
    ```sql
    SELECT setval('orders_seq', (to_char(current_date, 'YYYYMMDD') || '000')::bigint);
    ```
    
    - Здесь `current_date` берёт текущую дату.
    - `to_char(current_date, 'YYYYMMDD')` преобразует дату в формат `ГГГГММДД`.
    - Добавляется `000`, чтобы при следующем вызове `nextval` последовательность вернула `001` (например, для 1 августа 2024 года будет установлено значение `20240801000`).

Таким образом, при каждом вызове `nextval` последовательность будет выдавать следующий номер заказа, например, `20240801001`, `20240801002` и т.д.