# 11.56 DISTINCT

`DISTINCT` — это ключевое слово, которое используется для удаления дубликатов из результирующего набора данных. В отличие от `GROUP BY`, который также может использоваться для удаления дубликатов, `DISTINCT` не требует применения агрегатных функций. Его основная цель — просто убрать повторяющиеся строки в результатах запроса.

### Пример использования DISTINCT

Допустим, у нас есть таблица **`book_to_category`**, и нам нужно найти все уникальные идентификаторы книг, которые привязаны хотя бы к одной категории. Это можно сделать двумя способами:

1. **Использование GROUP BY**:
    
    ```sql
    select book_id from book_to_category group by book_id order by book_id;
    ```
    
2. **Использование DISTINCT**:
    
    ```sql
    select distinct book_id from book_to_category order by book_id;
    ```
    

В данном случае результат будет одинаковым, но использование `DISTINCT` более логично, потому что здесь нет необходимости применять группировку, если задача только в удалении дубликатов.

### DISTINCT и JSON-агрегация

В некоторых случаях, таких как агрегация данных в JSON, наличие дубликатов может привести к избыточности данных в результатах. Чтобы избежать этого, можно использовать `DISTINCT` внутри агрегатных функций, таких как `json_agg()`.

### Пример с JSON и DISTINCT

Допустим, у нас есть таблицы книг, авторов и категорий. Мы хотим получить JSON-агрегацию для каждой книги с её авторами и категориями. Вот запрос с использованием `DISTINCT` для удаления дубликатов:

```sql
SELECT
    b.name AS book_name,
    json_agg(distinct a.*) AS authors,
    json_agg(distinct c.*) AS categories
FROM book___ b
LEFT JOIN book____authors USING(book_id)
LEFT JOIN author___ a USING(author_id)
LEFT JOIN book____categories USING(book_id)
LEFT JOIN category___ c USING(category_id)
GROUP BY b.name
ORDER BY b.name;
```

### Что произойдёт, если убрать `DISTINCT`?

Если убрать `DISTINCT` из запроса, то в результате в JSON-агрегации могут появиться дубликаты, если одна и та же книга или автор несколько раз встречаются в результате запроса.

### Пример без группировки для наглядности

Чтобы понять, откуда берутся дубликаты, можно убрать группировку и посмотреть данные:

```sql
SELECT
    b.name AS book_name,
    a.name AS author,
    c.name AS category
FROM book___ b
LEFT JOIN book____authors USING(book_id)
LEFT JOIN author___ a USING(author_id)
LEFT JOIN book____categories USING(book_id)
LEFT JOIN category___ c USING(category_id)
ORDER BY b.name;
```

**Результат**:

| book_name | author | category |
| --- | --- | --- |
| Ариэль | Александр Беляев | Художественная литература |
| Ариэль | Александр Беляев | Научная фантастика |
| Голова профессора Доуэля | Александр Беляев | Научная фантастика |
| Голова профессора Доуэля | Александр Беляев | Художественная литература |
| Капитанская дочка | Александр Пушин | Художественная литература |
| Человек-амфибия | Александр Беляев | Научная фантастика |
| Человек-амфибия | Александр Беляев | Художественная литература |

Здесь мы видим дублирование авторов и категорий, потому что каждая книга связана с несколькими категориями и авторами. В результате эти связи повторяются в выводе.

### Когда использовать DISTINCT

- **Когда нужно просто убрать дубликаты**. Например, если необходимо вывести уникальные значения в одном или нескольких столбцах.
- **Когда данные группируются** и агрегация приводит к дублированию строк. Например, при агрегации данных в форматах, таких как JSON.