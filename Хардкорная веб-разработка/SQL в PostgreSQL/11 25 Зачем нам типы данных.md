# 11.25 Зачем нам типы данных?

Типы данных в базе данных играют важную роль в обеспечении целостности, оптимизации хранения и производительности. Рассмотрим эти аспекты подробнее.

### Приведение типов и использование `pg_column_size`

В PostgreSQL можно явно приводить одно значение к другому типу с помощью оператора `::`. Это полезно для проверки размера данных в байтах, что позволяет оценить, сколько места занимает значение конкретного типа данных на диске.

Примеры:

```sql
SELECT pg_column_size('333'::text);        -- 7 байт
SELECT pg_column_size('333'::varchar(3));  -- 7 байт
SELECT pg_column_size('333'::char(3));     -- 7 байт
SELECT pg_column_size('333'::char(255));   -- 259 байт

SELECT pg_column_size(333::bigint);        -- 8 байт
SELECT pg_column_size(333::int);           -- 4 байта
SELECT pg_column_size(333::smallint);      -- 2 байта

SELECT pg_column_size(333::numeric(3));    -- 8 байт
```

Этот пример показывает, что одно и то же значение может занимать разное количество байт в зависимости от типа данных.

### Целостность данных

Типы данных помогают поддерживать целостность данных. Например, если колонка имеет тип `int`, то попытка вставить туда строку приведет к ошибке:

```sql
CREATE TEMP TABLE book_tmp(name text, pages int);

-- Вставка с корректным значением
INSERT INTO book_tmp (name, pages) VALUES ('Python к вершинам мастерства', 898);

-- Ошибка: попытка вставить строку в поле типа int
INSERT INTO book_tmp (name, pages) VALUES ('Python к вершинам мастерства', 'тыща');
```

Это предотвращает некорректные данные и гарантирует, что в колонке будут храниться только целые числа.

### Дополнительные ограничения

Типы данных позволяют устанавливать дополнительные ограничения, которые помогают поддерживать целостность данных. Например, можно запретить отрицательное количество страниц в книге:

```sql
DROP TABLE IF EXISTS book_tmp;

CREATE TEMP TABLE book_tmp(
    name text,
    pages int CHECK (pages >= 1)  -- Ограничение на положительное количество страниц
);

-- Ошибка: попытка вставить отрицательное значение
INSERT INTO book_tmp (name, pages) VALUES ('Python к вершинам мастерства', -898);
```

Для других типов данных можно задавать свои ограничения, например, на длину строки или диапазон дат.

### Оптимизация хранения

Типы данных также влияют на оптимизацию хранения. Одно и то же значение может занимать различное количество байт в зависимости от типа данных. Это важно учитывать при проектировании базы данных, особенно если нужно хранить большое количество данных.

Пример:

- Если хранить значение `333` в типе `smallint`, оно займет всего 2 байта.
- Если использовать тип `char(255)`, то то же самое значение займет 259 байт.

Для 130 миллионов записей:

- 2 байта на запись займут 260 мегабайт.
- 259 байт на запись займут около 33 гигабайт.

Правильный выбор типов данных позволяет экономить место на диске, что особенно важно при больших объемах данных. Это также приводит к экономии места в индексах, которые дублируют информацию для ускорения поиска.

### Оптимизация производительности

Использование правильных типов данных также влияет на производительность. Меньшее количество данных требует меньше времени на чтение и обработку, что ускоряет выполнение запросов.

Пример:

- Считывание 260 мегабайт данных значительно быстрее, чем считывание 33 гигабайт, особенно при работе с большими объемами данных.

Таким образом, правильный выбор типов данных в базе данных не только обеспечивает целостность и надежность данных, но и позволяет эффективно использовать ресурсы хранения и улучшать производительность системы.