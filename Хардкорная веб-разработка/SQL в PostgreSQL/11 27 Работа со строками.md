# 11.27 Работа со строками

### Основные типы строковых данных

1. **`VARCHAR`**:
    - Строка переменной длины с ограничением на максимальную длину.
    - Проверяет, чтобы длина строки не превышала заданное ограничение при сохранении.
2. **`TEXT`**:
    - Строка переменной длины без ограничения на длину.
    - Не накладывает ограничений на длину строки при сохранении.
    - С точки зрения производительности, разницы между `VARCHAR` и `TEXT` в PostgreSQL нет.
3. **`CHAR`**:
    - Строка фиксированной длины.
    - Если длина сохраняемой строки меньше указанной, она дополняется пробелами.
    - Удобен для хранения данных фиксированной длины, например, кодов стран в формате ISO (2 символа).
    
    Пример создания таблицы:
    
    ```sql
    CREATE TEMP TABLE country (country_code CHAR(2), gdp_usd_trln INT);
    ```
    

### Операции со строками

1. **Получение длины строки**:
    
    ```sql
    SELECT length('привет'); -- 6
    ```
    
    Пример использования функции `length` в запросе:
    
    ```sql
    SELECT book_id, name, length(name) FROM book; -- Вернет длины названий книг
    ```
    
2. **Сортировка по длине строки**:
    
    ```sql
    SELECT book_id, name FROM book ORDER BY length(name) DESC;
    ```
    
3. **Конкатенация (склейка) строк**:
    
    ```sql
    SELECT 'Книга: ' || name AS name FROM book;
    
    SELECT 'Книга автора ' || a.name || ' «' || b.name || '»' AS book
    FROM book b
    JOIN author a USING(author_id)
    ORDER BY a.name, b.name;
    ```
    
    Пример вывода:
    
    ```markdown
    book
    -----------------------
    Книга автора Александр Беляев «Ариэль»
    Книга автора Александр Беляев «Вечный хлеб»
    ```
    
4. **Форматирование строк**:
    
    Вместо использования оператора `||` для склейки строк можно использовать функцию `format`:
    
    ```sql
    SELECT format('замечательный автор %s!', 'Пушкин');
    SELECT format('замечательный автор %s!', name) FROM author;
    
    SELECT format('Книга автора %s «%s»', a.name, b.name) AS book
    FROM book b
    JOIN author a USING(author_id)
    ORDER BY a.name, b.name;
    ```
    
5. **Извлечение подстроки** с помощью функции `substring`:
    
    ```sql
    SELECT substring('привет' FROM 1 FOR 5); -- приве
    SELECT substring('привет' FROM 1); -- привет
    SELECT substring('привет' FROM 1 FOR 2); -- пр
    SELECT substring('привет' FROM 2); -- ривет
    ```
    
6. **Замена подстроки** с помощью функции `replace`:
    
    ```sql
    SELECT replace('Саня любит пиво', 'пиво', 'бегать и подтягиваться'); -- Саня любит бегать и подтягиваться
    ```
    
7. **Проверка наличия подстроки** с помощью функции `position`:
    
    ```sql
    SELECT position('Саня' IN 'Саня любит бегать'); -- 1
    SELECT position('любит' IN 'Саня любит бегать'); -- 6
    SELECT position('не любит' IN 'Саня любит бегать'); -- 0
    ```
    
8. **Изменение регистра строки**:
    
    ```sql
    SELECT upper(name) FROM author;
    SELECT lower(name) FROM author;
    ```
    
9. **Приведение строки к числу**:
    
    Приведение строки к числовому типу данных можно выполнить с помощью оператора `::` или функции `cast`:
    
    ```sql
    SELECT '123'::int;
    SELECT '123.45'::int; -- Ошибка
    SELECT 'hello'::int; -- Ошибка
    
    SELECT cast('123' AS int);
    SELECT cast('hello' AS int); -- Ошибка
    ```
    
10. **Разбиение строки на части** и извлечение конкретной части с помощью функции `split_part`:
    
    ```sql
    SELECT split_part('2024-06-24', '-', 1); -- 2024
    SELECT split_part('2024-06-24', '-', 2); -- 06
    SELECT split_part('2024-06-24', '-', 3); -- 24
    ```