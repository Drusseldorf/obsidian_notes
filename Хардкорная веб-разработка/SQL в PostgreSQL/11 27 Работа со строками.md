# 11.27 Работа со строками

### Основные типы строковых данных

1. **`VARCHAR`**:
    - Строка переменной длины с ограничением на максимальную длину.
    - Проверяет, чтобы длина строки не превышала заданное ограничение при сохранении.
2. **`TEXT`**:
    - Строка переменной длины без ограничения на длину.
    - Не накладывает ограничений на длину строки при сохранении.
    - С точки зрения производительности, разницы между `VARCHAR` и `TEXT` в PostgreSQL нет.
3. **`CHAR`**:
    - Строка фиксированной длины.
    - Если длина сохраняемой строки меньше указанной, она дополняется пробелами.
    - Удобен для хранения данных фиксированной длины, например, кодов стран в формате ISO (2 символа).
    
    Пример создания таблицы:
    
    ```sql
    CREATE TEMP TABLE country (country_code CHAR(2), gdp_usd_trln INT);
    ```
    

### Операции со строками

1. **Получение длины строки**:
    
    ```sql
    SELECT length('привет'); -- 6
    ```
    
    Пример использования функции `length` в запросе:
    
    ```sql
    SELECT book_id, name, length(name) FROM book; -- Вернет длины названий книг
    ```
    
2. **Сортировка по длине строки**:
    
    ```sql
    SELECT book_id, name FROM book ORDER BY length(name) DESC;
    ```
    
3. **Конкатенация (склейка) строк**:
    
    ```sql
    SELECT 'Книга: ' || name AS name FROM book;
    
    SELECT 'Книга автора ' || a.name || ' «' || b.name || '»' AS book
    FROM book b
    JOIN author a USING(author_id)
    ORDER BY a.name, b.name;
    ```
    
    Пример вывода:
    
    ```markdown
    book
    -----------------------
    Книга автора Александр Беляев «Ариэль»
    Книга автора Александр Беляев «Вечный хлеб»
    ```
    
4. **Форматирование строк**:
    
    Вместо использования оператора `||` для склейки строк можно использовать функцию `format`:
    
    ```sql
    SELECT format('замечательный автор %s!', 'Пушкин');
    SELECT format('замечательный автор %s!', name) FROM author;
    
    SELECT format('Книга автора %s «%s»', a.name, b.name) AS book
    FROM book b
    JOIN author a USING(author_id)
    ORDER BY a.name, b.name;
    ```
    
5. **Извлечение подстроки** с помощью функции `substring`:
    
    ```sql
    SELECT substring('привет' FROM 1 FOR 5); -- приве
    SELECT substring('привет' FROM 1); -- привет
    SELECT substring('привет' FROM 1 FOR 2); -- пр
    SELECT substring('привет' FROM 2); -- ривет
    ```
    
6. **Замена подстроки** с помощью функции `replace`:
    
    ```sql
    SELECT replace('Саня любит пиво', 'пиво', 'бегать и подтягиваться'); -- Саня любит бегать и подтягиваться
    ```
    
7. **Проверка наличия подстроки** с помощью функции `position`:
    
    ```sql
    SELECT position('Саня' IN 'Саня любит бегать'); -- 1
    SELECT position('любит' IN 'Саня любит бегать'); -- 6
    SELECT position('не любит' IN 'Саня любит бегать'); -- 0
    ```
    
8. **Изменение регистра строки**:
    
    ```sql
    SELECT upper(name) FROM author;
    SELECT lower(name) FROM author;
    ```
    
9. **Приведение строки к числу**:
    
    Приведение строки к числовому типу данных можно выполнить с помощью оператора `::` или функции `cast`:
    
    ```sql
    SELECT '123'::int;
    SELECT '123.45'::int; -- Ошибка
    SELECT 'hello'::int; -- Ошибка
    
    SELECT cast('123' AS int);
    SELECT cast('hello' AS int); -- Ошибка
    ```
    
10. **Разбиение строки на части** и извлечение конкретной части с помощью функции `split_part`:
    
    ```sql
    SELECT split_part('2024-06-24', '-', 1); -- 2024
    SELECT split_part('2024-06-24', '-', 2); -- 06
    SELECT split_part('2024-06-24', '-', 3); -- 24
    ```

# Конспект из степика

**Текстовые функции в SQL**

---

### 1. CHAR_LENGTH(str)

- **Назначение**: Возвращает количество символов в строке `str`.
- **Пример**:
    
    `SELECT CHAR_LENGTH(''),        CHAR_LENGTH('b'),        CHAR_LENGTH('bee'),        CHAR_LENGTH('beegeek');`

---

### 2. LOWER(str)

- **Назначение**: Переводит все символы строки `str` в нижний регистр.
- **Пример**:
    
    `SELECT LOWER('beegeek'),        LOWER('BeeGeek'),        LOWER('BEEGEEK');`
    

---

### 3. UPPER(str)

- **Назначение**: Переводит все символы строки `str` в верхний регистр.
- **Пример**:
    
    `SELECT UPPER('beegeek'),        UPPER('BeeGeek'),        UPPER('BEEGEEK');`
    

---

### 4. LTRIM(str) и RTRIM(str)

- **Назначение**:
    - `LTRIM(str)` удаляет пробелы слева.
    - `RTRIM(str)` удаляет пробелы справа.
- **Пример**:
    
    `SELECT LTRIM('   bee'),        RTRIM('bee   ');`
    

---

### 5. REVERSE(str)

- **Назначение**: Разворачивает строку в обратном порядке.
- **Пример**:
    
    `SELECT REVERSE('b'),        REVERSE('bee'),        REVERSE('beegeek');`
    

---

### 6. REPEAT(str, count)

- **Назначение**: Повторяет строку `str` `count` раз. Если `count < 1`, возвращается пустая строка.
- **Пример**:
    
    `SELECT REPEAT('bee', 1),        REPEAT('bee', 2),        REPEAT('bee', 3),        REPEAT('bee', 0);`
    

---

### 7. LPAD(str, len, padstr) и RPAD(str, len, padstr)

- **Назначение**:
    
    - `LPAD` дополняет строку слева до длины `len` символами `padstr`.
    - `RPAD` дополняет строку справа.
- Если итоговая длина превышает `len`, избыточные символы `padstr` отбрасываются.
    
- Если `len` меньше длины исходной строки, обрезаются правые символы исходной строки (при LPAD) или левые (при RPAD – но фактически результат тот же: просто обрезка до `len`).
    
- **Примеры**:
    
    `-- LPAD SELECT LPAD('bee', 5, '-'),        LPAD('bee', 7, '-'),        LPAD('bee', 4, '-+-+');`
    
    `SELECT LPAD('bee', 2, '-');`
    
    `-- RPAD SELECT RPAD('bee', 5, '-'),        RPAD('bee', 7, '-+'),        RPAD('bee', 2, '-');`
    

---

### Важные замечания

1. **Функции с NULL**: При передаче `NULL` результатом большинства перечисленных функций также будет `NULL`.
2. **Использование в запросах**: Функции можно применять в любых частях запроса (`SELECT`, `WHERE`, `ORDER BY` и т.д.).
    
    `SELECT name FROM people ORDER BY CHAR_LENGTH(name);  -- сортируем по длине имени`
    
3. **Различия в СУБД**: Названия функций и синтаксис могут отличаться в разных СУБД.
4. **Числовые данные**: Некоторые строковые функции (например, `CHAR_LENGTH`, `REVERSE`, `REPEAT`, `LPAD`, `RPAD`) при необходимости неявно преобразуют число в строку.