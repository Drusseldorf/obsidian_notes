# 11.34 Изменяем структуру таблиц

В PostgreSQL можно изменять структуру существующих таблиц с помощью команды `ALTER TABLE`. Рассмотрим основные операции по изменению таблиц: добавление и удаление столбцов, добавление ограничений, переименование колонок и таблиц.

### Добавление колонки

Чтобы добавить новую колонку в существующую таблицу, используем команду `ALTER TABLE ... ADD COLUMN`. При добавлении новой колонки её значения для всех существующих записей будут установлены в `NULL`, если не указано иное:

```sql
ALTER TABLE book ADD COLUMN pages INT;
```

Теперь у таблицы `book` появилась колонка `pages` для хранения количества страниц в книге.

### Удаление и повторное добавление колонки

Если нужно удалить колонку, можно использовать команду `DROP COLUMN`:

```sql
ALTER TABLE book DROP COLUMN pages;
```

После этого колонка `pages` будет удалена, и её можно снова добавить:

```sql
ALTER TABLE book ADD COLUMN pages INT;
```

### Добавление ограничения на колонку

Можно установить ограничение на колонку, например, чтобы количество страниц было больше нуля. Для этого используется команда `ADD CONSTRAINT` с условием `CHECK`:

```sql
ALTER TABLE book ADD CONSTRAINT book_pages_positive CHECK (pages > 0);
```

Теперь PostgreSQL будет проверять, что в колонке `pages` не могут храниться значения меньше или равные нулю.

Примеры:

- Установим значение `NULL` для книги:
    
    ```sql
    UPDATE book SET pages = NULL WHERE name = 'Тихий Дон';
    ```
    
- Попробуем установить 0 страниц (получим ошибку из-за ограничения):
    
    ```sql
    UPDATE book SET pages = 0 WHERE name = 'Тихий Дон'; -- Ошибка
    ```
    
- Установим корректное значение:
    
    ```sql
    UPDATE book SET pages = 1472 WHERE name = 'Тихий Дон';
    ```
    

### Добавление ограничения без указания имени

Ограничение можно добавить и без явного указания имени ограничения, PostgreSQL сам сгенерирует имя:

```sql
ALTER TABLE book_json ADD CHECK (pages > 0);
```

### Переименование колонки

Для переименования колонки используется команда `RENAME COLUMN`:

```sql
ALTER TABLE book RENAME COLUMN pages TO book_pages;
```

Теперь колонка `pages` будет называться `book_pages`.

### Переименование таблицы

Чтобы переименовать таблицу, используется команда `RENAME TO`:

```sql
ALTER TABLE book RENAME TO rroom_book;
```

Теперь таблица `book` будет называться `rroom_book`.

### Установка ограничения `NOT NULL`

Если нужно сделать колонку обязательной для заполнения (чтобы не допускались `NULL` значения), можно использовать команду `SET NOT NULL`. Однако, если в таблице уже есть записи с `NULL` значениями, это вызовет ошибку:

```sql
ALTER TABLE book ALTER COLUMN pages SET NOT NULL; -- Ошибка, если есть NULL
```

Перед установкой ограничения нужно убедиться, что все существующие записи имеют ненулевые значения, или предварительно обновить их.