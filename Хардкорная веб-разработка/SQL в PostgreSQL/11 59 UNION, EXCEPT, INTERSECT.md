# 11.59 UNION, EXCEPT, INTERSECT

В SQL можно объединять результаты двух и более запросов с помощью операций над множествами: `UNION`, `INTERSECT` и `EXCEPT`. Эти операции позволяют обрабатывать результаты нескольких запросов как множества данных, выполняя над ними операции объединения, пересечения и вычитания.

### 1. **UNION**

Операция `UNION` объединяет результаты двух запросов, при этом убирает дублирующиеся строки (как и `DISTINCT`). Если нужно оставить дубликаты, используется `UNION ALL`.

```sql
-- Пример использования UNION:
-- Достанем имена всех авторов и всех категорий, собрав их в одном столбце
select name from author
union
select name from book_category;
```

Здесь запрос объединяет два набора данных: список имен авторов и список категорий книг. Если будут дубликаты, они удаляются. Если необходимо оставить дубликаты, можно использовать `UNION ALL`:

```sql
-- Пример использования UNION ALL:
-- Достанем имена всех авторов и всех категорий, сохранив дублирующиеся строки
select name from author
union all
select name from book_category;
```

### 2. **INTERSECT**

Операция `INTERSECT` возвращает только те строки, которые есть в обоих наборах данных. Дублирующие строки также удаляются, если не используется `INTERSECT ALL`.

```sql
-- Пример использования INTERSECT:
-- Достанем имена авторов, которые совпадают с названиями категорий книг
select name from author
intersect
select name from book_category;
```

Этот запрос возвращает только те строки, которые присутствуют и в таблице авторов, и в таблице категорий.

### 3. **EXCEPT**

Операция `EXCEPT` возвращает строки, которые присутствуют в первом запросе, но отсутствуют во втором. Дублирующиеся строки также убираются.

```sql
-- Пример использования EXCEPT:
-- Достанем авторов, у которых нет совпадений с названиями категорий книг
select name from author
except
select name from book_category;
```

Этот запрос вернет имена авторов, которые не совпадают с названиями категорий.

### 4. **Использование операций вместе**

Операции над множествами можно комбинировать, используя скобки для управления порядком выполнения. Например, можно выполнить объединение нескольких запросов, а затем применить вычитание или пересечение.

```sql
-- Пример объединения нескольких операций:
-- Достанем всех авторов и категории, а затем исключим тех, чье имя совпадает с названием категории
(select name from author
 union select name from book_category)
except
(select name from author
 intersect select name from book_category);
```

### 5. **Приоритет операций**

`INTERSECT` имеет более высокий приоритет по сравнению с `UNION` и `EXCEPT`. То есть, если не используются скобки, сначала выполняется пересечение, а потом объединение или вычитание.

```sql
-- Пример приоритета операций:
-- Достанем всех авторов и категории, а затем пересечем результат с запросом по третьей таблице
select name from author
union
select name from book_category
intersect
select name from some_other_table;
```

Этот запрос сначала выполнит пересечение второго и третьего запросов, а потом объединит результат с первым запросом.

### 6. **Ограничения на использование операций**

Для того чтобы использовать `UNION`, `INTERSECT` или `EXCEPT`, оба запроса должны возвращать одинаковое количество колонок, и типы данных в соответствующих колонках должны быть совместимыми.

```sql
-- Пример использования одинаковых столбцов:
-- Оба запроса возвращают по одному столбцу типа VARCHAR
select name from author
union
select name from book_category;
```

### 7. **Использование LIMIT**

Если нужно применить `LIMIT` только к одному из запросов, важно использовать скобки. Иначе `LIMIT` будет применен ко всему результату.

```sql
-- Пример использования LIMIT с UNION:
-- Ограничим выборку только для второго запроса
select name from author
union
(select name from book_category limit 2);
```

### 8. **Порядок выполнения операций**

SQL позволяет контролировать очередность выполнения операций с помощью скобок.

```sql
-- Пример использования нескольких операций:
-- Сначала выполнится пересечение, затем объединение
(select name from author
 intersect select name from book_category)
union
select name from some_other_table;
```