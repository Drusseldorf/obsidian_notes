# Poetry

## Инициализируем новый проект (если уже есть написанный код и хотим там поставить poetry)

Установить в локальный проект или глобально на пк:

```python
 pip install poetry
```

Проинициализировать проект в котором уже написан код:

```python
poetry init
```

Далее poetry спросить какие указать настройки для проекта:

1. Название для проекта
2. Версию (можно оставить 0.1.0)
3. Описание или указать потом
4. Автор или указать потом
5. Лицензию (например MIT для свободного ПО)
6. Совместимая версия Python
7. Далее спросить хотим ли мы установить зависимости в интерактивном формате

В интерактивном режиме можно просто писать строку и он найдет все пакеты которые содержат это в названии и предложит выбрать подходящий.
Затем предлагает выбрать версию, можно оставить пустым и нажать энтер, тогда выберет последнюю версию в пакете

Далее poetry спросить про установку девелопмент зависимостей. Это зависимости которые нужно для разработки ПО, например, тестирование или линтинг. Например поставить pytest.

Далее poetry выведет и спросить устраивает ли нас полученная конфигурация. Если да, то он создаст в корне проекта файл томл. Там зафиксированы зависимости и настройки конфигурации.

Но это пока не установлено в нашем виртуальном окружении.

Пишем команду:

```python
poetry install
```

Это установит все зависимости из лок файла, если его нет, то он будет создан.

Лок файл - по сути томл файл в котором содержатся установленные зависимости. 

Чтобы добавить новую зависимость нужна команда:

```python
 poetry add "uvicorn[standart]”
```

Чтобы добавить зависимость именно как зависимость для процесса разработки то:

```bash
poetry add --group dev pytest
```

в двойных кавычках потому что прямоугольные скобки используются, поэтому это нужно экранировать, ибо в терминале двойные кавычки могут быть интерпретированы иначе в терминале.

standart - стандартный набор зависимостей

Лок файл обновляется при этом автоматически, то есть зависимость уже установлена после команды add, но лишний раз можно убедиться через команду install

Так же при желании можно вручную редактировать файл томл, добавляя туда новые зависимости после чего уже выполнить команду install нужно будет обязательно.

А вот лок нельзя трогать, он обновляется сам. К тому же там есть хэши, которые помогают poetry следить что никто не трогал файл вручную.

оба файла нужно добавлять в гит, они должны быть в репозитории.

Наличие файла лок гарантирует что будут установлены именно те зависимости которые действительно были в нашем проекте, которые мы там хотим видеть.

## Изменили томл, что делать?

Что делает команда poetry lock [--no-update]

Команда `poetry lock` используется для генерации или обновления файла `poetry.lock` на основе зависимостей, указанных в `pyproject.toml`.

Вот что она делает в двух вариантах:

1. **`poetry lock`**:
    - Эта команда создаёт или обновляет файл `poetry.lock`, разрешая все зависимости, указанные в `pyproject.toml`.
    - Если у вас уже есть файл `poetry.lock`, но вы добавили или изменили зависимости в `pyproject.toml`, эта команда пересоберёт зависимости и обновит файл `poetry.lock`.
    - При этом она может обновить версии пакетов до самых последних, которые удовлетворяют ограничениям, указанным в `pyproject.toml`.
2. **`poetry lock --no-update`**:
    - Эта команда генерирует или восстанавливает файл `poetry.lock`, **не обновляя версии зависимостей**.
    - Она будет использовать те версии пакетов, которые уже были закодированы в существующем файле `poetry.lock`, без попытки обновления до более свежих версий. Это полезно, если вы хотите пересоздать файл `poetry.lock` на основе текущих зависимостей, но при этом сохранить стабильные версии, которые уже были зафиксированы.

Вкратце:

- `poetry lock` пересобирает зависимости и может обновить пакеты до более новых версий.
- `poetry lock --no-update` пересобирает зависимости, но не обновляет версии пакетов.

После того как сделали lock просто выполняет install, который установит все из лок файла

## Есть лок и есть томл, хотим установить

Если у вас уже есть файлы `pyproject.toml` и `poetry.lock`, и вы хотите установить все зависимости, выполните следующие шаги:

1. **Убедитесь, что Poetry установлен**:
Если Poetry ещё не установлен, выполните команду для его установки, например, через pip
2. **Установите зависимости с помощью Poetry**:
Оказавшись в корневой директории проекта (где находятся файлы `pyproject.toml` и `poetry.lock`), выполните команду:
    
    ```bash
    poetry install
    ```
    
    Эта команда:
    
    - Прочитает файл `poetry.lock` и установит версии всех зависимостей, которые были зафиксированы в этом файле.
    - Если файла `poetry.lock` нет, то она создаст его на основе зависимостей из `pyproject.toml`.
3. **Если нужны зависимости для разработки**:
Если проект содержит dev-зависимости (например, для тестирования или разработки), установите их с флагом:
    
    ```bash
    poetry install --with dev
    ```
    

Итог:

- Если у вас есть и `pyproject.toml`, и `poetry.lock`, просто выполните команду `poetry install`, чтобы установить все зависимости, как это было зафиксировано в проекте.

## Показать зависимости

```bash
poetry show --tree
```

## Если создаем новый проект (еще нет написанного кода)

```bash
poetry new package_name
```

Команда создаст папки для тестов, ридмишку, папку тмп, свой томл файл. Ну типа общая заготовочка

## Poetry помогает работать с виртуальными окружениями

### Создать виртуальное окружение

```bash
poetry env use python3.12 
```

Указываем версию питона, предполагается что она прописана в path, иначе нужно полный путь до интерпретатора.

Виртуальное окружения создается в домашней директории в .cache папки

То есть как бы окружения нет конкретно в папке проекта, но мы им можем пользоваться через poetry.

### Запустить виртуальное окружение

```bash
poetry shell
```

а чтобы выйти: exit

### Запуск приложения в venv без активации venv в оболочке

Можно через 

```bash
poetry run <что-то исполняемое>
```

## Узнать текущую версию пакетов и последние версии в pypi (пакеты питона)

```bash
poetry show --latest
```

## Скрипты через poetry

В томл файле poetry прописать новый блок

```bash
[tool.poetry.scripts]
somecommand = "tmp.main:run"
```

Теперь если вызвать из оболочки 

```bash
poetry run somecommand
```

то будет исполнен файл tmp.main (там код питоновский)

## Как настроить IDE для работы с poetry, ведь виртуальное окружение лежит на в папке проекта

В IDE требуется указать интерпретатор который используется в этом проекте.

Можно решить проблемку:

Из виртуального окружения в оболочке вызвать which python (для линуксовых)

Либо:

```bash
poetry env info
```

Она покажет путь до виртуального окружения

## Синхронизировать с уже установленными пакетами

```bash
poetry install --sync
```

Есть нюанс, что если poetry установлен в том же окружении, то он будет добавлять и свои пакеты тоже при синхронизации. Так что лучше poetry ставить глобально, а не в рамках вашего конкретного виртуального окружения.

## Обновить какую-то зависимость

```bash
poetry update fastapi
```