
## 1. Что такое миграции?

- Механизм Django для создания и изменения таблиц в базе данных на основе моделей.
- Сохраняются в папке `migrations/` каждого приложения и являются частью проекта.

## 2. Два шага миграций

1. **makemigrations**
    
    - Анализирует модели и создаёт файл(ы) миграций с описанием изменений.
    - Никаких изменений в БД не вносит.
    
    ```bash
    python manage.py makemigrations
    ```
    
2. **migrate**
    
    - Применяет миграции в БД.
    - Выполняет сгенерированные SQL-запросы.
    
    ```bash
    python manage.py migrate
    ```
    

## 3. Файлы миграций

- Создаются и нумеруются автоматически.
- Содержат инструкции, из которых формируются SQL-запросы.
- Хранятся в Git (являются частью приложения).

### Пример структуры миграций

```bash
ice_cream/
├── migrations/
│   ├── __init__.py
│   └── 0001_initial.py
└── models.py
```

- `0001_initial.py` — первая миграция с операциями создания моделей.

## 4. Полезные команды

- **python manage.py migrate** — применяет миграции.
- **python manage.py makemigrations** — создаёт новые миграции.
- **python manage.py sqlmigrate <app_name> <migration_number>** — показывает итоговый SQL.

## 5. Типовой порядок развёртывания

1. `git clone <url>`
2. `python -m venv venv` и `source venv/bin/activate`
3. `pip install -r requirements.txt`
4. `python manage.py migrate`

> **Примечание**: Когда миграции уже лежат в репозитории, `makemigrations` заново делать не нужно.

## 6. Итог

- Миграции — связующее звено между моделями на Python и таблицами в БД.
- Храните файлы миграций в репозитории для удобства совместной разработки.
- При желании можно просмотреть SQL-запросы перед применением миграций (`sqlmigrate`).

## 7. Откат миграций

Если необходимо отменить последние изменения в базе:

1. **Откат последней миграции**
    
    ```bash
    python manage.py migrate <app_name> <предыдущая_миграция>
    ```
    
    - Например, если текущая миграция `0003_auto` и вы хотите откатиться к `0002_auto`, выполните:
        
        ```bash
        python manage.py migrate <app_name> 0002
        ```
        
    - Django выполнит операции «обратного хода», прописанные в файлах миграций.
2. **Откат к самому началу**
    
    ```bash
    python manage.py migrate <app_name> zero
    ```
    
    - Все таблицы, связанные с указанным приложением, будут удалены, вернувшись к «пустому» состоянию.
3. **Просмотр списка применённых миграций**
    
    ```bash
    python manage.py showmigrations
    ```
    
    - Показывает, какие миграции выполнены в каждом приложении и какие ещё не применены.

> **Совет**: Тщательно проверяйте, нет ли данных, потеря которых при откате миграций будет критичной. Для «боевых» проектов откат миграций — операция повышенной опасности.