# Создание моделей (таблиц)

### Модель пользователя

```python
class User(Base):
    __tablename__ = 'user'

    user_id: Mapped[int] = mapped_column(primary_key=True)
    telegram_id: Mapped[int] = mapped_column(BigInteger, unique=True, nullable=False)

    # Связь с уведомлениями, каскадное удаление уведомлений при удалении пользователя
    notifications = relationship("Notification", back_populates="user", cascade="all, delete-orphan")
```

- **`notifications`**: Устанавливает связь "один ко многим" с уведомлениями. Аргумент `cascade="all, delete-orphan"` указывает, что при удалении пользователя также удаляются его уведомления. `delete-orphan` удаляет уведомления, если они больше не связаны с пользователем.

### Модель уведомления

```python
class Notification(Base):
    __tablename__ = 'notification'

    notification_id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey('user.user_id', ondelete='CASCADE'), nullable=False)
    datetime_utc: Mapped[datetime] = mapped_column(DateTime, nullable=False)
    event_name: Mapped[str] = mapped_column(String(255), nullable=False)

    # Связь с пользователем
    user = relationship("User", back_populates="notifications")
```

- **`user_id`**: Внешний ключ с параметром `ondelete='CASCADE'` — автоматически удаляет уведомления при удалении пользователя в базе данных.
- **`user`**: Обратная связь с моделью `User`, которая позволяет получать пользователя из уведомления.

### Асинхронная инициализация базы данных

```python
async def async_main():
    async with engine.begin() as connection:
        connection.run_sync(Base.metadata.create_all)
```

Этот код используется для создания таблиц в базе данных асинхронно

Если таблицы уже существуют в базе данных, то вызов функции `Base.metadata.create_all` через асинхронный контекст:

```python
async def async_main():
    async with engine.begin() as connection:
        connection.run_sync(Base.metadata.create_all)
```

не приведет к их повторному созданию или перезаписи.

### Подробности:

- **`create_all()`**: Эта функция проверяет наличие таблиц перед их созданием. Если таблица уже существует, то SQLAlchemy не будет её перезаписывать или изменять. Она просто пропустит создание этой таблицы.
- **Что она делает**: Если какой-либо таблицы нет, она создаст её. Если все таблицы уже присутствуют, ничего не произойдет.

### Важные моменты:

- **Не обновляет схему**: Эта функция **не вносит изменения** в существующую структуру таблиц. Если тебе нужно обновить схему (например, добавить новые столбцы или изменить существующие), потребуется использовать инструменты миграции, такие как `Alembic`.