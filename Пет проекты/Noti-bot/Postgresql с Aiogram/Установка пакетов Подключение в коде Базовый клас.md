# Установка пакетов. Подключение в коде. Базовый класс

Обычно в структуре проекта создается пакет database, который содержит два модуля:

- models.py - структура базы данных (модели orm)
- requests.py - запросы в БД

## Устанавливаем пакеты.

Драйвер для подключения к БД под управлением Постгреса - asyncpg 

SQLalchemy - это инструмент, позволяющий работать с записями в БД и с таблицами, как с объектами Питона, ORM - Object-Relational Mapping

ORM (Object-Relational Mapping): Это подсистема SQLAlchemy, которая позволяет преобразовать данные из базы данных в объекты Python и обратно. Это удобно, так как вы можете работать с данными как с обычными объектами, вместо того чтобы писать SQL-запросы вручную.

SQL Expression Language: Это низкоуровневый интерфейс SQLAlchemy, который позволяет строить SQL-запросы с использованием Python-кода, не прибегая к прямому написанию SQL. Этот подход предоставляет большую гибкость и контроль.
SQLAlchemy предоставляет вам полный контроль над SQL-запросами, позволяя при этом использовать высокоуровневые абстракции через ORM, что делает работу с базами данных в Python более удобной и эффективной

```python
pip install sqlalchemy asyncpg
```

## Выполняем подключение к БД:

```python
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column
from sqlalchemy.ext.asyncio import AsyncAttrs, async_sessionmaker, create_async_engine

engine = create_async_engine(url='тут урл подключения к бд')
```

`Engine` в SQLAlchemy — это основной объект, который отвечает за управление подключением к базе данных и выполнением SQL-запросов. Он представляет собой "движок" базы данных и обеспечивает взаимодействие с ней на низком уровне. Это базовый компонент SQLAlchemy, через который происходит выполнение всех операций с базой данных.

Когда вы создаете объект `Engine`, вы фактически устанавливаете соединение с базой данных (или конфигурацию для последующего соединения) и предоставляете интерфейс для выполнения SQL-запросов, транзакций и других операций.

### Основные аспекты `Engine`:

1. **Подключение к базе данных**: `Engine` управляет пулом соединений (или единственным соединением в случае SQLite) и предоставляет доступ к базе данных через этот пул.
2. **Выполнение SQL-запросов**: `Engine` может напрямую выполнять SQL-запросы без использования ORM, предоставляя возможность выполнения сырого SQL через методы вроде `execute()`.
3. **Работа с транзакциями**: С помощью `Engine` можно управлять транзакциями на уровне базы данных, фиксировать или откатывать их.

### Асинхронный `Engine`

Когда вы используете `create_async_engine` (вместо синхронного `create_engine`), движок конфигурируется для работы в асинхронном режиме, что важно для асинхронных приложений. Асинхронный движок позволяет выполнять все операции с базой данных асинхронно, что улучшает производительность в случаях, когда работа с базой данных не должна блокировать выполнение программы.

## Фабрика Сессий

```python
async_session = async_sessionmaker(engine)
```

**`async_sessionmaker`** — это специальная функция в SQLAlchemy, которая используется для создания фабрики сессий в асинхронных приложениях. Она возвращает объект, который можно использовать для создания экземпляров `AsyncSession`.

### Что делает этот код:

- Создается фабрика сессий (`async_sessionmaker`), которая привязывается к определенному движку (`engine`). Эта фабрика сессий затем может быть использована для создания конкретных экземпляров `AsyncSession`.
- Каждый раз, когда вам нужно будет взаимодействовать с базой данных в асинхронном режиме, вы будете использовать фабрику `async_session`, чтобы создать новый объект сессии.

### Пример использования:

```python
# Создание сессии с использованием ранее созданной фабрики
async with async_session() as session:
    result = await session.execute(select(User))
    users = result.scalars().all()
```

## Создание базового класса

```python
class Base(AsyncAttrs, DeclarativeBase):
    pass
```

создается базовый класс `Base`, который будет использоваться для всех моделей в ORM SQLAlchemy в асинхронном контексте. Этот класс объединяет функциональность асинхронных атрибутов (`AsyncAttrs`) и декларативной базы (`DeclarativeBase`). Вот зачем это нужно:

### 1. **`DeclarativeBase`**:

- **`DeclarativeBase`** — это базовый класс для декларативного стиля ORM в SQLAlchemy. Он используется для создания моделей, которые будут отображать таблицы базы данных.
- Когда вы создаете классы-модели (например, таблицы базы данных), они наследуются от этого базового класса, чтобы SQLAlchemy мог автоматически связать их с таблицами в базе данных.

Пример:

```python
class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String, nullable=False)

```

### 2. **`AsyncAttrs`**:

- **`AsyncAttrs`** — это специальный миксин (набор функциональности) из SQLAlchemy, который добавляет поддержку асинхронных атрибутов к ORM-моделям.
- Этот миксин используется для обеспечения асинхронных операций в рамках моделей ORM. Например, для асинхронного получения и установки значений полей объектов, что необходимо в асинхронных приложениях, где не должно быть блокировок.

В случае если код не асинхронный, то классическое создание Base класса выглядит так:

```python
Base = declarative_base()
```